#
#
#

FROM alpine:latest

MAINTAINER Jaren Glover <@JarenGlover>

RUN apk update && apk add \
        git \
        python \
        pip-py \
        && rm -rf /var/cache/apk/* \
        && pip install -r requirements.txt

RUN mkdir -p /docs

# Clone down latest resume
RUN cd /docs && git clone https://github.com/JarenGlover/resume.git

# ADD the nginx file for the routing
COPY resume.sites-enabled /etc/nginx/conf.d/resume.sites-enabled.conf

RUN sed -i '/access_log/a\
    log_format upstreamlog "[$time_local] $remote_addr passed to: $upstream_addr: $request Upstream Response Time: $upstream_response_time Request time: $request_time";' /etc/nginx/nginx.conf

# Append "daemon off;" to the configuration file
RUN echo "daemon off;" >> /etc/nginx/nginx.conf

#expose ports
EXPOSE 80

# start nginx in background
RUN nginx&

# start resume webservice on port 4000
ENTRYPOINT [gunicorn -w 4 -b 0.0.0.0:4000 resume:app]